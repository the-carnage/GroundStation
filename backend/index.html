<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>HW-233 OTA Live (Red Glow Edition)</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }

      :root {
        --bg-dark: #121212;
        --card-dark: #1e1e1e;
        --text-light: #ffffff;
        --text-muted: #aaaaaa;
        --glow-red: #ff004c;
        --glow-red-light: #ff3377;
        --chart-line-color: #ff004c;
        --chart-fill-color: rgba(255, 0, 76, 0.15);
        --success-green: #00e676;
        --error-red: #ff3d00;
        --border-color: #333333;
        --input-bg: #2a2a2a;
      }

      html, body {
        font-family: "Inter", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-dark);
        color: var(--text-light);
        margin: 0;
        padding: 0;
        min-height: 100vh;
        overflow-x: hidden;
        width: 100%;
      }

      /* Overlay backdrop */
      .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .sidebar-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      /* Sidebar as overlay */
      .sidebar {
        position: fixed;
        top: 0;
        left: -320px;
        width: 280px;
        height: 100vh;
        background-color: var(--card-dark);
        padding: 30px 20px;
        padding-top: 20px;
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        gap: 15px;
        border-right: 1px solid var(--border-color);
        transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
        overflow-y: auto;
        overflow-x: hidden;
      }

      .sidebar.active {
        left: 0;
      }
      
      .sidebar nav {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .sidebar-close {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 38px;
        height: 38px;
        background-color: rgba(255, 0, 76, 0.15);
        border: 2px solid var(--glow-red);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--glow-red);
        font-size: 1.2rem;
        transition: all 0.3s ease;
        z-index: 10;
      }

      .sidebar-close:hover {
        background-color: var(--glow-red);
        color: white;
        transform: translateX(-3px) scale(1.05);
        box-shadow: 0 0 15px rgba(255, 0, 76, 0.6);
      }
      
      .sidebar-close i {
        font-weight: 900;
        font-size: 1.4rem;
      }

      /* Hamburger menu button */
      .hamburger-menu {
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        width: 32px;
        height: 32px;
        background-color: rgba(255, 0, 76, 0.1);
        border: 1px solid var(--glow-red);
        border-radius: 6px;
        cursor: pointer;
        padding: 6px;
        transition: all 0.3s ease;
        position: relative;
      }

      .hamburger-menu:hover {
        background-color: rgba(255, 0, 76, 0.2);
        transform: scale(1.05);
        box-shadow: 0 0 10px rgba(255, 0, 76, 0.3);
      }

      .hamburger-menu span {
        width: 100%;
        height: 2px;
        background-color: var(--glow-red);
        border-radius: 2px;
        transition: all 0.3s ease;
      }

      /* Sidebar scrollbar */
      .sidebar::-webkit-scrollbar {
        width: 6px;
      }

      .sidebar::-webkit-scrollbar-track {
        background: var(--card-dark);
      }

      .sidebar::-webkit-scrollbar-thumb {
        background: var(--glow-red);
        border-radius: 3px;
      }

      .sidebar::-webkit-scrollbar-thumb:hover {
        background: var(--glow-red-light);
      }

      .logo {
        font-size: 1.6rem;
        font-weight: 700;
        color: var(--glow-red);
        text-align: center;
        margin-bottom: 25px;
        margin-top: 40px;
        letter-spacing: 1px;
        text-shadow: 0 0 10px rgba(255, 0, 76, 0.3);
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 8px;
        color: var(--text-muted);
        text-decoration: none;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        white-space: nowrap;
        position: relative;
        overflow: hidden;
      }

      .nav-item:hover {
        background-color: rgba(255, 0, 76, 0.1);
        color: var(--text-light);
        transform: translateX(3px);
      }

      .nav-item.active {
        background-color: var(--glow-red);
        color: var(--text-light);
        box-shadow: 0 0 10px rgba(255, 0, 76, 0.4);
      }

      .nav-item.active::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 3px;
        background-color: white;
      }

      .nav-item i {
        font-size: 1.2rem;
      }

      .dashboard-layout {
        width: 100%;
        max-width: 100vw;
        display: grid;
        grid-template-rows: auto 1fr;
        grid-template-columns: 1fr;
        gap: 20px;
        padding: 20px 15px;
        box-sizing: border-box;
        overflow-x: hidden;
      }

      .header-bar {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        background-color: var(--card-dark);
        padding: 15px 30px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color);
        gap: 20px;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
        justify-self: start;
      }

      .header-center {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
      }

      .app-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--glow-red);
        letter-spacing: 1.5px;
        text-shadow: 0 0 12px rgba(255, 0, 76, 0.4);
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .app-title i {
        font-size: 1.6rem;
      }

      .search-bar {
        position: relative;
        display: flex;
        align-items: center;
      }

      .search-bar input {
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px 15px 10px 40px;
        color: var(--text-light);
        font-size: 0.9rem;
        outline: none;
        width: 250px;
      }

      .search-bar input::placeholder {
        color: var(--text-muted);
      }

      .search-bar i {
        position: absolute;
        left: 15px;
        color: var(--text-muted);
      }

      .weather-info {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 20px;
        justify-self: end;
      }

      .user-profile {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text-light);
      }

      .user-profile img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid var(--glow-red);
      }

      .main-grid {
        /* CHANGED: Single column stacking layout */
        display: flex;
        flex-direction: column; 
        gap: 20px;
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
      }

      .overview-card,
      .sensor-card,
      .chart-card,
      .info-card {
        background-color: var(--card-dark);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .sensor-grid {
        /* CHANGED: Now spans full width and uses grid for inner layout */
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }
      
      .sensor-group {
          background-color: var(--card-dark);
          padding: 20px;
          border-radius: 12px;
          border: 1px solid var(--border-color);
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      .sensor-group h2 {
          font-size: 1.1rem;
          color: var(--glow-red-light);
          margin: 0 0 15px 0;
          padding-bottom: 5px;
          border-bottom: 1px solid var(--input-bg);
      }

      .sensor-group .sensor-value-item {
          background-color: var(--input-bg);
          margin-bottom: 10px;
          padding: 12px 15px;
      }

      .sensor-group .sensor-value-item:last-child {
          margin-bottom: 0;
      }

      .current-values-section {
        grid-column: 1 / 2;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }

      .status-card {
        padding: 15px 20px;
        background-color: var(--input-bg);
        border-radius: 10px;
        text-align: left;
        border: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .status-card .label {
        color: var(--text-muted);
        font-size: 0.85rem;
        margin-bottom: 5px;
      }
      .status-card .value {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--glow-red-light);
      }
      .status-card .unit {
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      .status-indicator {
        font-size: 0.8rem;
        padding: 4px 10px;
        border-radius: 20px;
        display: inline-block;
        margin-top: 10px;
      }
      .status-indicator.connected {
        background-color: var(--success-green);
        color: var(--bg-dark);
      }
      .status-indicator.disconnected {
        background-color: var(--error-red);
        color: var(--text-light);
      }

      .map-card {
        padding: 0;
        grid-column: unset;
        grid-row: unset;
      }

      .map-image {
        width: 100%;
        height: 350px;
        object-fit: cover;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
      }

      .map-details {
        padding: 20px;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        background-color: var(--card-dark);
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 12px;
      }
      .map-detail-item {
        text-align: left;
      }
      .map-detail-item .label {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-bottom: 5px;
      }
      .map-detail-item .value {
        font-size: 1.1rem;
        font-weight: 500;
        color: var(--text-light);
      }
      .map-detail-item:last-child {
        text-align: right;
      }
      .map-detail-item .value.health-good {
        color: var(--success-green);
      }

      .chart-section {
        grid-column: unset;
        background-color: var(--card-dark);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
      }
      .chart-header h3 {
        margin: 0;
        color: var(--glow-red);
        font-size: 1.2rem;
      }
      .chart-controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .chart-controls label {
        color: var(--text-muted);
        font-size: 0.85rem;
      }
      .chart-controls select,
      .chart-controls button {
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-light);
        padding: 8px 12px;
        font-size: 0.85rem;
        cursor: pointer;
        outline: none;
        transition: border-color 0.2s;
      }
      .chart-controls select:focus,
      .chart-controls button:hover {
        border-color: var(--glow-red-light);
      }
      .chart-controls button {
        background-color: var(--glow-red);
        border-color: var(--glow-red);
        box-shadow: 0 0 8px rgba(255, 0, 76, 0.4);
      }
      .chart-controls button:hover {
        background-color: var(--glow-red-light);
        border-color: var(--glow-red-light);
      }


      .chart-area {
        position: relative;
        flex-grow: 1;
        height: 350px;
        margin-top: 15px;
      }
      canvas {
        background-color: transparent;
        border-radius: 8px;
      }

      .sensor-value-item {
        background-color: var(--input-bg);
        padding: 15px 20px;
        border-radius: 10px;
        text-align: left;
        border: 1px solid var(--border-color);
      }
      .sensor-value-item .label {
        color: var(--text-muted);
        font-size: 0.85rem;
        margin-bottom: 5px;
      }
      .sensor-value-item .value {
        font-size: 1.6rem;
        font-weight: 600;
        color: var(--glow-red-light);
      }
      .sensor-value-item .unit {
        font-size: 1rem;
        color: var(--text-muted);
        margin-left: 5px;
      }

      .info-panel {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 15px;
        text-align: center;
      }
      .info-panel strong {
        color: var(--text-light);
      }

      /* Export Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
      }

      .modal-overlay.active {
        display: flex;
      }

      .export-modal {
        background-color: var(--card-dark);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        width: 90%;
        max-width: 550px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        animation: modalSlideIn 0.3s ease;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .export-modal::-webkit-scrollbar {
        width: 6px;
      }

      .export-modal::-webkit-scrollbar-track {
        background: var(--card-dark);
      }

      .export-modal::-webkit-scrollbar-thumb {
        background: var(--glow-red);
        border-radius: 3px;
      }

      .modal-header {
        padding: 20px 25px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        color: var(--glow-red);
        font-size: 1.4rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .modal-close {
        width: 32px;
        height: 32px;
        background-color: transparent;
        border: 2px solid var(--glow-red);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--glow-red);
        font-size: 1.2rem;
        transition: all 0.3s ease;
      }

      .modal-close:hover {
        background-color: var(--glow-red);
        color: white;
        transform: rotate(90deg);
      }

      .modal-body {
        padding: 25px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        color: var(--text-light);
        font-size: 0.95rem;
        font-weight: 500;
        margin-bottom: 8px;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px 12px;
        color: var(--text-light);
        font-size: 0.95rem;
        outline: none;
        transition: border-color 0.2s ease;
      }

      .form-group input:focus,
      .form-group select:focus {
        border-color: var(--glow-red);
      }

      .checkbox-group {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        max-height: 200px;
        overflow-y: auto;
        padding: 10px;
        background-color: var(--input-bg);
        border-radius: 8px;
        border: 1px solid var(--border-color);
      }

      .checkbox-group::-webkit-scrollbar {
        width: 6px;
      }

      .checkbox-group::-webkit-scrollbar-thumb {
        background: var(--glow-red);
        border-radius: 3px;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px;
        border-radius: 4px;
        transition: background-color 0.2s ease;
      }

      .checkbox-item:hover {
        background-color: rgba(255, 0, 76, 0.05);
      }

      .checkbox-item input[type="checkbox"] {
        width: auto;
        cursor: pointer;
        accent-color: var(--glow-red);
      }

      .checkbox-item label {
        margin: 0;
        cursor: pointer;
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      .checkbox-item input:checked + label {
        color: var(--text-light);
        font-weight: 500;
      }

      .select-all-btn {
        background-color: transparent;
        border: 1px solid var(--glow-red);
        color: var(--glow-red);
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        margin-bottom: 10px;
        transition: all 0.2s ease;
      }

      .select-all-btn:hover {
        background-color: rgba(255, 0, 76, 0.1);
      }

      .browse-path-btn {
        padding: 10px 20px;
        background-color: var(--glow-red);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .browse-path-btn:hover {
        background-color: var(--glow-red-light);
        box-shadow: 0 0 10px rgba(255, 0, 76, 0.4);
        transform: translateY(-1px);
      }

      .path-input-group {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .modal-footer {
        padding: 20px 25px;
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .modal-footer button {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .btn-cancel {
        background-color: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-muted);
      }

      .btn-cancel:hover {
        background-color: rgba(255, 255, 255, 0.05);
        color: var(--text-light);
      }

      .btn-export {
        background-color: var(--glow-red);
        color: white;
        box-shadow: 0 0 10px rgba(255, 0, 76, 0.3);
      }

      .btn-export:hover {
        background-color: var(--glow-red-light);
        box-shadow: 0 0 15px rgba(255, 0, 76, 0.5);
        transform: translateY(-2px);
      }

      @import url("https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css");
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
    </style>
  </head>
  <body>
    <!-- Sidebar overlay backdrop -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar as overlay -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-close" id="sidebarClose">
        <i class="fas fa-angle-left"></i>
      </div>
      <div class="logo">Ground Station</div>
      <nav>
        <a href="#" class="nav-item active"
          ><i class="fas fa-home"></i> <span>Dashboard</span></a
        >
        <a href="#" class="nav-item"><i class="fas fa-leaf"></i> <span>My Fields</span></a>
        <a href="#" class="nav-item"><i class="fas fa-tasks"></i> <span>Tasks</span></a>
        <a href="#" class="nav-item"
          ><i class="fas fa-edit"></i> <span>CRS/PM Modification</span></a
        >
        <a href="#" class="nav-item"
          ><i class="fas fa-chart-line"></i> <span>Reports</span></a
        >
        <a href="#" class="nav-item"><i class="fas fa-cogs"></i> <span>Automation</span></a>
        <a href="#" class="nav-item"
          ><i class="fas fa-store"></i> <span>Marketplace</span></a
        >
        <a href="#" class="nav-item"><i class="fas fa-users"></i> <span>Community</span></a>
      </nav>
    </aside>

    <div class="dashboard-layout">
      <header class="header-bar">
        <div class="header-left">
          <button class="hamburger-menu" id="hamburgerMenu">
            <span></span>
            <span></span>
            <span></span>
          </button>
        </div>
        <div class="header-center">
          <div class="app-title">
            <i class="fas fa-satellite-dish"></i>
            Ground Station
          </div>
        </div>
        <div class="header-right">
          <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Search" />
          </div>
          <div class="user-profile">
            <img src="https://ui-avatars.com/api/?name=Carnage&background=ff004c&color=fff&bold=true&size=40" alt="Carnage" />
            <span>Carnage</span>
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
      </header>

      <main class="main-grid">
        <div class="map-card">
          <div id="googleMap" class="map-image"></div>

          <div class="map-details">
            <div class="map-detail-item">
              <div class="label">Latitude</div>
              <div class="value" id="gpsLatitude">--</div>
            </div>
            <div class="map-detail-item">
              <div class="label">Longitude</div>
              <div class="value" id="gpsLongitude">--</div>
            </div>
            <div class="map-detail-item">
              <div class="label">Time (UTC)</div>
              <div class="value health-good" id="gpsTime">--</div>
            </div>
            <div class="map-detail-item">
              <div class="label">Date</div>
              <div class="value" id="gpsDate">--</div>
            </div>
            <div class="map-detail-item">
              <div class="label">Altitude</div>
              <div class="value" id="gpsAltitude">
                --<span class="unit">m</span>
              </div>
            </div>
            <div class="map-detail-item">
              <div class="label">Speed</div>
              <div class="value" id="gpsSpeed">
                --<span class="unit">km/h</span>
              </div>
            </div>
          </div>
        </div>
        <div class="chart-section">
          <div class="chart-header">
            <h3>Real-time Data Stream</h3>
            <div class="chart-controls">
              <label for="chartDataType">Chart Data:</label>
              <select id="chartDataType">
                <option value="ota" selected>OTA Value</option>
                <option value="voltage">Voltage (V)</option>
                <option value="temperature">Temperature (Â°C)</option>
                <option value="pressure">Pressure (hPa)</option>
                <option value="battery">Battery (%)</option>
                <option value="batt_current">Battery Current (A)</option>
                <option value="accel">Accelerometer (All Axes)</option>
                <option value="gyro">Gyroscope (All Axes)</option>
                <option value="esc">ESC RPM (All)</option>
                <option value="gps_sats">GPS Satellites</option>
              </select>
              <label for="chartDataWindow">Show Last:</label>
              <select id="chartDataWindow">
                <option value="10">10 Pts</option>
                <option value="30" selected>30 Pts</option>
                <option value="60">60 Pts</option>
                <option value="120">120 Pts</option>
              </select>
              <label for="timeRange">Time Range:</label>
              <select id="timeRange">
                <option value="0">All Data</option>
                <option value="10">Last 10 min</option>
                <option value="30">Last 30 min</option>
                <option value="60">Last 60 min</option>
              </select>
              <label for="serialPort">Port:</label>
              <select id="serialPort" disabled>
                <option value="">Scanning for portsâ€¦</option>
              </select>
              <button id="scanPortsBtn" onclick="manualScanPorts()" title="Scan for serial ports">
                <i class="fas fa-sync-alt"></i> Scan
              </button>
              <label for="baudRate">Baud:</label>
              <select id="baudRate" disabled>
                <option value="9600">9600</option>
                <option value="115200" selected>115200</option>
              </select>
              <button id="applySettings" disabled>Apply Settings</button>
              <button onclick="openExportModal()">
                <i class="fas fa-download"></i> Export Data
              </button>
            </div>
          </div>
          <div class="chart-area">
            <canvas id="liveChart"></canvas>
          </div>
          <div class="info-panel">
            Connection:
            <span class="status-indicator disconnected" id="connectionStatus"
              >Disconnected</span
            >
            &bull; Last Update:
            <strong id="lastDataUpdate">Waiting...</strong> &bull; Total
            Records: <strong id="totalDataRecords">0</strong>
          </div>
        </div>
        <div class="sensor-grid">
          <div class="sensor-group">
              <h2>Power & Core</h2>
              <div class="sensor-value-item">
                  <div class="label">Primary Sensor (OTA)</div>
                  <div class="value">
                      <span id="primarySensorValue">--</span><span class="unit">units</span>
                  </div>
              </div>
              <div class="sensor-value-item">
                  <div class="label">Battery Voltage</div>
                  <div class="value">
                      <span id="systemVoltage">--</span><span class="unit">V</span>
                  </div>
              </div>
              <div class="sensor-value-item">
                  <div class="label">Battery Charge (%)</div>
                  <div class="value">
                      <span id="batteryCharge">--</span><span class="unit">%</span>
                  </div>
                  <div class="info-panel">
                      Current: <span id="battCurrent">--</span> A
                  </div>
              </div>
          </div>

          <div class="sensor-group">
              <h2>Environment & GPS</h2>
              <div class="sensor-value-item">
                  <div class="label">Air Temperature (BMP280)</div>
                  <div class="value">
                      <span id="temperatureValue">--</span><span class="unit">Â°C</span>
                  </div>
              </div>
              <div class="sensor-value-item">
                  <div class="label">Air Pressure (BMP280)</div>
                  <div class="value">
                      <span id="pressureValue">--</span><span class="unit">hPa</span>
                  </div>
              </div>
              <div class="sensor-value-item">
                  <div class="label">GPS Satellites</div>
                  <div class="value">
                      <span id="gpsSats">--</span><span class="unit">Sats</span>
                  </div>
              </div>
          </div>

          <div class="sensor-group">
              <h2>Motion & Control</h2>
              <div class="sensor-value-item">
                  <div class="label">Accel X / Y / Z</div>
                  <div class="value">
                      <span id="accelX">--</span>/<span id="accelY">--</span>/<span id="accelZ">--</span>
                  </div>
              </div>
              <div class="sensor-value-item">
                  <div class="label">Gyro X (Yaw Rate)</div>
                  <div class="value">
                      <span id="gyroX">--</span><span class="unit">Â°/s</span>
                  </div>
              </div>
              <div class="sensor-value-item">
                  <div class="label">ESC RPM (1 & 2)</div>
                  <div class="value">
                      <span id="esc1Rpm">--</span>/<span id="esc2Rpm">--</span>
                  </div>
                  <div class="info-panel">
                      ESC (3/4): <span id="esc3Rpm">--</span>/<span id="esc4Rpm">--</span>
                  </div>
              </div>
          </div>
        </div>
      </main>
    </div>

    <script
      async
      defer
      src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"
    ></script>

    <script>
      // Sidebar overlay toggle functionality
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      const hamburgerMenu = document.getElementById('hamburgerMenu');
      const sidebarClose = document.getElementById('sidebarClose');
      
      function openSidebar() {
        sidebar.classList.add('active');
        sidebarOverlay.classList.add('active');
      }
      
      function closeSidebar() {
        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
      }
      
      hamburgerMenu.addEventListener('click', openSidebar);
      sidebarClose.addEventListener('click', closeSidebar);
      sidebarOverlay.addEventListener('click', closeSidebar);
      
      // Close sidebar when clicking on nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', closeSidebar);
      });

      const dataStreamSocket = io({ transports: ["websocket"] });
      dataStreamSocket.on('connect_error', (err) => {
        console.error('Socket connect_error', err);
      });
      dataStreamSocket.on('reconnect_attempt', () => console.log('Socket reconnect attempt'));

      const connectionStatusDisplay = document.getElementById("connectionStatus");
      const lastDataUpdateDisplay = document.getElementById("lastDataUpdate");
      const totalDataRecordsDisplay = document.getElementById("totalDataRecords");

      const primarySensorDisplay = document.getElementById("primarySensorValue");
      const systemVoltageDisplay = document.getElementById("systemVoltage");
      const temperatureDisplay = document.getElementById("temperatureValue");
      // REMOVED: const humidityDisplay = document.getElementById("humidityValue"); // No dedicated humidity field in UI
      const batteryChargeDisplay = document.getElementById("batteryCharge");
      
      const pressureDisplay = document.getElementById("pressureValue"); // Used for Pressure (BMP280 data)
      const battCurrentDisplay = document.getElementById("battCurrent");
      const gpsSatsDisplay = document.getElementById("gpsSats");

      const accelXDisplay = document.getElementById("accelX");
      const accelYDisplay = document.getElementById("accelY");
      const accelZDisplay = document.getElementById("accelZ");
      const gyroXDisplay = document.getElementById("gyroX");
      const esc1RpmDisplay = document.getElementById("esc1Rpm");
      const esc2RpmDisplay = document.getElementById("esc2Rpm");
      const esc3RpmDisplay = document.getElementById("esc3Rpm");
      const esc4RpmDisplay = document.getElementById("esc4Rpm");

      const gpsLatitudeDisplay = document.getElementById("gpsLatitude");
      const gpsLongitudeDisplay = document.getElementById("gpsLongitude");
      const gpsTimeDisplay = document.getElementById("gpsTime");
      const gpsDateDisplay = document.getElementById("gpsDate");
      const gpsAltitudeDisplay = document.getElementById("gpsAltitude");
      const gpsSpeedDisplay = document.getElementById("gpsSpeed");

      const chartDataWindowSelect = document.getElementById("chartDataWindow");

      const serialPortSelect = document.getElementById("serialPort");
      const baudRateSelect = document.getElementById("baudRate");
      const applySettingsButton = document.getElementById("applySettings");

      let dataPointCounter = 0;
      let liveChartInstance = null;
      let fullHistoricalData = [];
      let maxChartDataPoints = parseInt(chartDataWindowSelect.value);

      let map;
      let marker;
      const defaultCenter = { lat: 0, lng: 0 };

      function setSerialPortPlaceholder(message) {
        if (!serialPortSelect) return;
        serialPortSelect.innerHTML = "";
        serialPortSelect.disabled = true;
        const option = document.createElement("option");
        option.value = "";
        option.disabled = true;
        option.selected = true;
        option.textContent = message;
        serialPortSelect.appendChild(option);
        // mark placeholder as 'stale' so polling will try to refresh
        lastPortUpdate = 0;
      }

      function formatPortLabel(port) {
        if (port.friendlyName) {
          return `${port.friendlyName}`;
        }
        if (port.manufacturer) {
          return `${port.manufacturer} - ${port.path}`;
        }
        return port.path || "Serial Port";
      }

      function populateSerialPortSelect(ports) {
        if (!serialPortSelect) return;
        console.log('populateSerialPortSelect called with', ports?.length || 0, 'ports');
        if (!Array.isArray(ports) || ports.length === 0) {
          setSerialPortPlaceholder("No serial ports found");
          return;
        }

        // Save the currently selected port before clearing
        const currentlySelectedPort = serialPortSelect.value;
        console.log('Currently selected port:', currentlySelectedPort);

        serialPortSelect.innerHTML = "";
        serialPortSelect.disabled = false;
        
        let foundCurrentPort = false;
        ports.forEach((port, index) => {
          const option = document.createElement("option");
          option.value = port.path;
          option.textContent = formatPortLabel(port);
          
          // Restore the previously selected port if it still exists
          if (currentlySelectedPort && port.path === currentlySelectedPort) {
            option.selected = true;
            foundCurrentPort = true;
            console.log('Restored previously selected port:', port.path);
          } else if (!currentlySelectedPort && index === 0) {
            // Only auto-select first port if no port was previously selected
            option.selected = true;
          }
          
          serialPortSelect.appendChild(option);
        });
        
        if (currentlySelectedPort && !foundCurrentPort) {
          console.log('Previously selected port no longer available:', currentlySelectedPort);
        }
        
        console.log('Serial port select populated with', ports.length, 'ports');
        lastPortUpdate = Date.now();
      }

      async function refreshSerialPorts() {
        if (!serialPortSelect) return;
        setSerialPortPlaceholder("Scanning for portsâ€¦");

        try {
          const response = await fetch("/api/serial-ports", { cache: "no-store" });
          if (!response.ok) {
            throw new Error("Failed to load serial ports");
          }
          const payload = await response.json();
          populateSerialPortSelect(Array.isArray(payload?.ports) ? payload.ports : []);
        } catch (error) {
          setSerialPortPlaceholder(error?.message || "Failed to load serial ports");
          console.error("Serial port refresh failed:", error);
        }
      }

      // Manual port scan triggered by button click
      async function manualScanPorts() {
        const scanBtn = document.getElementById('scanPortsBtn');
        if (scanBtn) scanBtn.disabled = true;
        
        console.log('Manual port scan triggered');
        setSerialPortPlaceholder("Scanning for portsâ€¦");
        
        try {
          // Trigger backend to scan ports
          const response = await fetch("/api/serial-ports/scan", { 
            method: "POST",
            cache: "no-store" 
          });
          
          if (!response.ok) {
            throw new Error("Failed to scan serial ports");
          }
          
          const payload = await response.json();
          populateSerialPortSelect(Array.isArray(payload?.ports) ? payload.ports : []);
          console.log('Manual scan complete:', payload.ports?.length || 0, 'ports found');
        } catch (error) {
          setSerialPortPlaceholder(error?.message || "Scan failed");
          console.error("Manual port scan failed:", error);
        } finally {
          if (scanBtn) scanBtn.disabled = false;
        }
      }
      window.manualScanPorts = manualScanPorts;

      function var_to_js(cssVar) {
        return getComputedStyle(document.documentElement).getPropertyValue(
          cssVar
        );
      }

      // Timestamp of the last successful port list update (ms since epoch)
      let lastPortUpdate = 0;

      // Automatic polling disabled - use manual scan button instead
      // const PORT_POLL_INTERVAL = 5000;
      // setInterval(() => {
      //   if (Date.now() - lastPortUpdate > Math.max(3000, PORT_POLL_INTERVAL - 1000)) {
      //     console.log('Polling fallback: refreshing serial ports');
      //     refreshSerialPorts();
      //   }
      // }, PORT_POLL_INTERVAL);

      window.initMap = function () {
        const mapElement = document.getElementById("googleMap");
        if (!mapElement) return;

        map = new google.maps.Map(mapElement, {
          zoom: 15,
          center: defaultCenter,
          mapId: "8097b6a655af4e91",
          disableDefaultUI: true,
          gestureHandling: "cooperative",
        });

        marker = new google.maps.Marker({
          position: defaultCenter,
          map: map,
          title: "Device Location",
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: var_to_js("--glow-red"),
            fillOpacity: 0.9,
            strokeWeight: 0,
            scale: 8,
          },
        });
        console.log("Google Map Initialized.");
      };

      chartDataWindowSelect.addEventListener("change", (event) => {
        maxChartDataPoints = parseInt(event.target.value);
        updateChartDisplay();
      });

      // Add event listener for chart data type selector
      const chartDataTypeSelect = document.getElementById("chartDataType");
      if (chartDataTypeSelect) {
        chartDataTypeSelect.addEventListener("change", () => {
          updateChartDisplay();
        });
      }

      dataStreamSocket.on("connect", () => {
        console.log('Socket connected');
        baudRateSelect.disabled = false;
        applySettingsButton.disabled = false;

        if (!connectionStatusDisplay.textContent.includes("Arduino")) {
          connectionStatusDisplay.textContent = "Server Connected";
          connectionStatusDisplay.className = "status-indicator connected";
        }

        // Don't auto-refresh on reconnect - use manual scan button
        // refreshSerialPorts();
      });

      dataStreamSocket.on("disconnect", () => {
        connectionStatusDisplay.textContent = "Disconnected";
        connectionStatusDisplay.className = "status-indicator disconnected";
        serialPortSelect.disabled = true;
        baudRateSelect.disabled = true;
        applySettingsButton.disabled = true;
      });

      dataStreamSocket.on("serial_status", (status) => {
        if (status.serial_connected === true) {
          connectionStatusDisplay.textContent = "Arduino Connected";
          connectionStatusDisplay.className = "status-indicator connected";
        } else {
          connectionStatusDisplay.textContent = "Serial Port Error";
          connectionStatusDisplay.className = "status-indicator disconnected";
        }
      });

      dataStreamSocket.on("serial_port_list", (ports) => {
        console.log('Received serial_port_list event:', ports);
        populateSerialPortSelect(Array.isArray(ports) ? ports : []);
      });

      dataStreamSocket.on('serial_baud', (payload) => {
        try {
          const b = Number(payload?.baud);
          if (!Number.isFinite(b)) return;
          // If baud not present in select, add it
          let found = false;
          for (let i = 0; i < baudRateSelect.options.length; i++) {
            if (Number(baudRateSelect.options[i].value) === b) {
              found = true;
              break;
            }
          }
          if (!found) {
            const opt = document.createElement('option');
            opt.value = String(b);
            opt.textContent = String(b);
            baudRateSelect.appendChild(opt);
          }
          baudRateSelect.value = String(b);
          console.log('Serial baud updated to', b);
        } catch (e) { console.error('Failed to handle serial_baud', e); }
      });

      dataStreamSocket.on("serial_port_list_error", (payload) => {
        console.error('Serial port list error:', payload);
        setSerialPortPlaceholder(payload?.message || "Failed to load serial ports");
      });


      window.addEventListener("DOMContentLoaded", function () {
        const chartCanvas = document.getElementById("liveChart");
        if (!chartCanvas) return;

        Chart.defaults.color = "#ffffff";
        Chart.defaults.borderColor = "#333333";

        liveChartInstance = new Chart(chartCanvas.getContext("2d"), {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "OTA Value",
                data: [],
                borderColor: "#ff004c",
                backgroundColor: "rgba(255, 0, 76, 0.15)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 6,
                pointBackgroundColor: "#ff004c",
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
                hidden: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
              duration: 0,
            },
            plugins: {
              legend: {
                display: true,
                position: "top",
                labels: {
                  color: var_to_js("--text-light"),
                },
              },
              tooltip: {
                mode: "index",
                intersect: false,
                backgroundColor: var_to_js("--bg-dark"),
                titleColor: var_to_js("--glow-red"),
                bodyColor: var_to_js("--text-light"),
                borderColor: var_to_js("--border-color"),
                borderWidth: 1,
              },
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: "Time",
                  color: var_to_js("--text-light"),
                },
                ticks: {
                  maxRotation: 45,
                  minRotation: 0,
                  color: var_to_js("--text-muted"),
                },
                grid: { color: var_to_js("--border-color") },
              },
              y: {
                beginAtZero: false,
                min: 0,
                max: 1023,
                title: {
                  display: true,
                  text: "Sensor Value (0-1023)",
                  color: var_to_js("--text-light"),
                },
                ticks: { color: var_to_js("--text-muted") },
                grid: { color: var_to_js("--border-color") },
              },
            },
          },
        });
      });

      // Listen for new telemetry_update events (replaces new_data)
      dataStreamSocket.on("telemetry_update", (receivedData) => {
        if (!liveChartInstance) return;

        // Log received data for debugging (comment out in production)
        console.log('ðŸ“Š Telemetry received:', receivedData);

        const currentTime = new Date().toLocaleTimeString();
        dataPointCounter++;

        primarySensorDisplay.textContent = receivedData.ota || "--";
        systemVoltageDisplay.textContent = receivedData.voltage
          ? receivedData.voltage.toFixed(2)
          : "--";
        temperatureDisplay.textContent = receivedData.temperature
          ? receivedData.temperature.toFixed(1)
          : "--";
        // NOTE: receivedData.humidity is mapped to 'pressure' value in serialmonitor.js
        pressureDisplay.textContent = receivedData.humidity 
            ? receivedData.humidity.toFixed(1) 
            : "--";
        batteryChargeDisplay.textContent = receivedData.battery || "--";
        battCurrentDisplay.textContent = receivedData.batt_current
            ? receivedData.batt_current.toFixed(2)
            : "--";
        gpsSatsDisplay.textContent = receivedData.gps_sats || "--";

        accelXDisplay.textContent = receivedData.accel_x
          ? receivedData.accel_x.toFixed(2)
          : "--";
        accelYDisplay.textContent = receivedData.accel_y
          ? receivedData.accel_y.toFixed(2)
          : "--";
        accelZDisplay.textContent = receivedData.accel_z
          ? receivedData.accel_z.toFixed(2)
          : "--";
        gyroXDisplay.textContent = receivedData.gyro_x
          ? receivedData.gyro_x.toFixed(2)
          : "--";

        esc1RpmDisplay.textContent = receivedData.esc1_rpm || "--";
        esc2RpmDisplay.textContent = receivedData.esc2_rpm || "--";
        esc3RpmDisplay.textContent = receivedData.esc3_rpm || "--";
        esc4RpmDisplay.textContent = receivedData.esc4_rpm || "--";

        lastDataUpdateDisplay.textContent = currentTime;
        totalDataRecordsDisplay.textContent = dataPointCounter;

        if (map && receivedData.gps_lat && receivedData.gps_lon) {
          const newPosition = {
            lat: Number(receivedData.gps_lat),
            lng: Number(receivedData.gps_lon),
          };

          marker.setPosition(newPosition);
          map.panTo(newPosition);

          gpsLatitudeDisplay.textContent = receivedData.gps_lat.toFixed(5);
          gpsLongitudeDisplay.textContent = receivedData.gps_lon.toFixed(5);
          // NOTE: gps_time and gps_date are derived locally in serialmonitor.js
          gpsTimeDisplay.textContent = receivedData.gps_time || "--";
          gpsDateDisplay.textContent = receivedData.gps_date || "--";
          gpsAltitudeDisplay.textContent = receivedData.gps_alt
            ? receivedData.gps_alt.toFixed(1)
            : "--";
          gpsSpeedDisplay.textContent = receivedData.gps_speed
            ? receivedData.gps_speed.toFixed(1)
            : "--";
        } else if (map) {
          gpsLatitudeDisplay.textContent = "--";
          gpsLongitudeDisplay.textContent = "--";
          gpsTimeDisplay.textContent = "--";
          gpsDateDisplay.textContent = "--";
          gpsAltitudeDisplay.textContent = "--";
          gpsSpeedDisplay.textContent = "--";
        }

        fullHistoricalData.push({
          timestamp: new Date().toISOString(),
          ota: receivedData.ota,
          voltage: receivedData.voltage,
          temperature: receivedData.temperature,
          // NOTE: Using 'pressure' to save the BMP280 data, as it's correctly named in the CSV/DB.
          pressure: receivedData.humidity, 
          battery: receivedData.battery,
          gps_sats: receivedData.gps_sats,
          gps_lat: receivedData.gps_lat,
          gps_lon: receivedData.gps_lon,
          gps_time: receivedData.gps_time,
          gps_date: receivedData.gps_date,
          gps_alt: receivedData.gps_alt,
          gps_speed: receivedData.gps_speed,
          accel_x: receivedData.accel_x,
          accel_y: receivedData.accel_y,
          accel_z: receivedData.accel_z,
          gyro_x: receivedData.gyro_x,
          gyro_y: receivedData.gyro_y,
          gyro_z: receivedData.gyro_z,
          batt_current: receivedData.batt_current,
          esc1_rpm: receivedData.esc1_rpm,
          esc2_rpm: receivedData.esc2_rpm,
          esc3_rpm: receivedData.esc3_rpm,
          esc4_rpm: receivedData.esc4_rpm,
        });

        updateChartDisplay();
      });

      function updateChartDisplay() {
        if (!liveChartInstance) return;

        const displayedData = fullHistoricalData.slice(-maxChartDataPoints);
        const chartType = document.getElementById('chartDataType')?.value || 'ota';

        liveChartInstance.data.labels = displayedData.map((item) =>
          new Date(item.timestamp).toLocaleTimeString()
        );

        // Clear existing datasets
        liveChartInstance.data.datasets = [];

        // Add datasets based on selected chart type
        switch(chartType) {
          case 'ota':
            liveChartInstance.data.datasets.push({
              label: 'OTA Value',
              data: displayedData.map(item => Number(item.ota) || 0),
              borderColor: '#ff004c',
              backgroundColor: 'rgba(255, 0, 76, 0.15)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 3,
            });
            break;
          case 'voltage':
            liveChartInstance.data.datasets.push({
              label: 'Voltage (V)',
              data: displayedData.map(item => Number(item.voltage) || 0),
              borderColor: '#00e676',
              backgroundColor: 'rgba(0, 230, 118, 0.15)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 3,
            });
            break;
          case 'temperature':
            liveChartInstance.data.datasets.push({
              label: 'Temperature (Â°C)',
              data: displayedData.map(item => Number(item.temperature) || 0),
              borderColor: '#ff9800',
              backgroundColor: 'rgba(255, 152, 0, 0.15)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 3,
            });
            break;
          case 'pressure':
            liveChartInstance.data.datasets.push({
              label: 'Pressure (hPa)',
              data: displayedData.map(item => Number(item.pressure) || 0),
              borderColor: '#2196f3',
              backgroundColor: 'rgba(33, 150, 243, 0.15)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 3,
            });
            break;
          case 'battery':
            liveChartInstance.data.datasets.push({
              label: 'Battery (%)',
              data: displayedData.map(item => Number(item.battery) || 0),
              borderColor: '#4caf50',
              backgroundColor: 'rgba(76, 175, 80, 0.15)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 3,
            });
            break;
          case 'batt_current':
            liveChartInstance.data.datasets.push({
              label: 'Battery Current (A)',
              data: displayedData.map(item => Number(item.batt_current) || 0),
              borderColor: '#ffc107',
              backgroundColor: 'rgba(255, 193, 7, 0.15)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 3,
            });
            break;
          case 'accel':
            liveChartInstance.data.datasets.push(
              {
                label: 'Accel X',
                data: displayedData.map(item => Number(item.accel_x) || 0),
                borderColor: '#ff004c',
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointRadius: 2,
              },
              {
                label: 'Accel Y',
                data: displayedData.map(item => Number(item.accel_y) || 0),
                borderColor: '#00e676',
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointRadius: 2,
              },
              {
                label: 'Accel Z',
                data: displayedData.map(item => Number(item.accel_z) || 0),
                borderColor: '#2196f3',
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointRadius: 2,
              }
            );
            break;
          case 'gyro':
            liveChartInstance.data.datasets.push(
              {
                label: 'Gyro X',
                data: displayedData.map(item => Number(item.gyro_x) || 0),
                borderColor: '#ff004c',
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointRadius: 2,
              },
              {
                label: 'Gyro Y',
                data: displayedData.map(item => Number(item.gyro_y) || 0),
                borderColor: '#00e676',
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointRadius: 2,
              },
              {
                label: 'Gyro Z',
                data: displayedData.map(item => Number(item.gyro_z) || 0),
                borderColor: '#2196f3',
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointRadius: 2,
              }
            );
            break;
          case 'esc':
            liveChartInstance.data.datasets.push(
              {
                label: 'ESC1 RPM',
                data: displayedData.map(item => Number(item.esc1_rpm) || 0),
                borderColor: '#ff004c',
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointRadius: 2,
              },
              {
                label: 'ESC2 RPM',
                data: displayedData.map(item => Number(item.esc2_rpm) || 0),
                borderColor: '#00e676',
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointRadius: 2,
              },
              {
                label: 'ESC3 RPM',
                data: displayedData.map(item => Number(item.esc3_rpm) || 0),
                borderColor: '#2196f3',
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointRadius: 2,
              },
              {
                label: 'ESC4 RPM',
                data: displayedData.map(item => Number(item.esc4_rpm) || 0),
                borderColor: '#ffc107',
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointRadius: 2,
              }
            );
            break;
          case 'gps_sats':
            liveChartInstance.data.datasets.push({
              label: 'GPS Satellites',
              data: displayedData.map(item => Number(item.gps_sats) || 0),
              borderColor: '#9c27b0',
              backgroundColor: 'rgba(156, 39, 176, 0.15)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 3,
            });
            break;
          default:
            liveChartInstance.data.datasets.push({
              label: 'OTA Value',
              data: displayedData.map(item => Number(item.ota) || 0),
              borderColor: '#ff004c',
              backgroundColor: 'rgba(255, 0, 76, 0.15)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 3,
            });
        }

        liveChartInstance.update('none');
      }

      // Export functions using backend API
      // Export Modal Functions
      function openExportModal() {
        document.getElementById('exportModal').classList.add('active');
      }

      function closeExportModal() {
        document.getElementById('exportModal').classList.remove('active');
      }

      function toggleSelectAllAttributes() {
        const checkboxes = document.querySelectorAll('#attributesList input[type="checkbox"]');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => cb.checked = !allChecked);
      }

      async function selectSavePath() {
        if (!window.electronAPI) {
          alert('File dialog is only available in Electron app');
          return;
        }

        const format = document.getElementById('exportFormat').value;
        const customFilename = document.getElementById('exportFilename').value.trim();
        const ext = format === 'csv' ? 'csv' : format === 'xlsx' ? 'xlsx' : 'json';
        const defaultName = customFilename || `telemetry_${new Date().toISOString().replace(/[:.]/g, '-')}.${ext}`;
        
        const selectedPath = await window.electronAPI.selectSavePath(defaultName);
        if (selectedPath) {
          document.getElementById('exportPath').value = selectedPath;
        }
      }

      async function performExport() {
        const format = document.getElementById('exportFormat').value;
        const timeframe = document.getElementById('exportTimeframe').value;
        const clearAfter = document.getElementById('clearAfterExport').checked;
        const customFilename = document.getElementById('exportFilename').value.trim();
        const selectedPath = document.getElementById('exportPath').value;
        
        // Get selected attributes
        const selectedAttributes = Array.from(
          document.querySelectorAll('#attributesList input[type="checkbox"]:checked')
        ).map(cb => cb.value);

        if (selectedAttributes.length === 0) {
          alert('Please select at least one attribute to export!');
          return;
        }

        try {
          let url, filename;
          
          if (format === 'csv') {
            url = `/api/export/csv?minutes=${timeframe}&clear=${clearAfter}`;
            filename = customFilename || `telemetry_${new Date().toISOString().replace(/[:.]/g, '-')}.csv`;
          } else if (format === 'xlsx') {
            url = `/api/export/xlsx?minutes=${timeframe}&clear=${clearAfter}`;
            filename = customFilename || `telemetry_${new Date().toISOString().replace(/[:.]/g, '-')}.xlsx`;
          } else {
            // JSON export
            url = `/api/telemetry?minutes=${timeframe}`;
            filename = customFilename || `telemetry_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
          }

          const response = await fetch(url);
          
          if (!response.ok) {
            throw new Error('Export failed');
          }

          let blob;
          if (format === 'json') {
            const data = await response.json();
            // Filter data to only include selected attributes
            const filteredData = data.map(item => {
              const filtered = {};
              selectedAttributes.forEach(attr => {
                if (item[attr] !== undefined) {
                  filtered[attr] = item[attr];
                }
              });
              return filtered;
            });
            const dataStr = JSON.stringify(filteredData, null, 2);
            blob = new Blob([dataStr], { type: 'application/json' });
          } else {
            blob = await response.blob();
          }

          // If running in Electron with a selected path, use it
          if (selectedPath && window.electronAPI) {
            // Write file using Electron's fs
            const reader = new FileReader();
            reader.onload = async function() {
              const arrayBuffer = this.result;
              const uint8Array = new Uint8Array(arrayBuffer);
              
              try {
                // Send data to main process to write file
                const writeSuccess = await window.electronAPI.writeFile(selectedPath, uint8Array);
                if (writeSuccess) {
                  closeExportModal();
                  alert(`Data exported successfully to:\n${selectedPath}`);
                } else {
                  throw new Error('Failed to write file');
                }
              } catch (err) {
                console.error('File write error:', err);
                alert('Failed to save file: ' + err.message);
              }
            };
            reader.readAsArrayBuffer(blob);
          } else {
            // Fallback to browser download
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(downloadUrl);
            a.remove();

            closeExportModal();
            alert(`Data exported successfully as ${format.toUpperCase()}!`);
          }
        } catch (error) {
          console.error('Export error:', error);
          alert('Failed to export data: ' + error.message);
        }
      }

      // Legacy export functions (kept for compatibility)
      async function exportDataCSV() {
        document.getElementById('exportFormat').value = 'csv';
        openExportModal();
      }
      
      async function exportDataXLSX() {
        const timeRange = document.getElementById('timeRange').value;
        const clearAfter = confirm('Clear data from memory after export?');
        
        try {
          const url = `/api/export/xlsx?minutes=${timeRange}&clear=${clearAfter}`;
          const response = await fetch(url);
          
          if (!response.ok) {
            throw new Error('Export failed');
          }
          
          const result = await response.json();
          
          if (!result.success) {
            throw new Error(result.error || 'Export failed');
          }
          
          // Note: Full XLSX conversion would require SheetJS library
          // For now, download as JSON
          const dataStr = JSON.stringify(result.data, null, 2);
          const blob = new Blob([dataStr], { type: 'application/json' });
          const downloadUrl = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = downloadUrl;
          a.download = result.filename.replace('.xlsx', '.json');
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(downloadUrl);
          a.remove();
          
          alert('Data exported as JSON! (Install SheetJS for XLSX)');
        } catch (error) {
          console.error('Export error:', error);
          alert('Failed to export: ' + error.message);
        }
      }

      function saveDataAsCsv() {
        if (fullHistoricalData.length === 0) {
          alert("No data collected yet to export!");
          return;
        }

        const headers = [
          "Timestamp",
          "OTA_Value",
          "Voltage_V",
          "Temperature_C",
          "Pressure_hPa", // Corrected header for CSV
          "Battery_Pct",
          "Battery_Current_A",
          "GPS_Satellites",
          "GPS_Lat",
          "GPS_Lon",
          "GPS_Time",
          "GPS_Date",
          "GPS_Altitude_m",
          "GPS_Speed_kmh",
          "Accel_X",
          "Accel_Y",
          "Accel_Z",
          "Gyro_X",
          "Gyro_Y",
          "Gyro_Z",
          "ESC1_RPM",
          "ESC2_RPM",
          "ESC3_RPM",
          "ESC4_RPM",
        ];
        const csvRows = [];

        csvRows.push(headers.join(","));

        fullHistoricalData.forEach((row) => {
          const values = [
            row.timestamp,
            row.ota,
            row.voltage,
            row.temperature,
            row.pressure, // This field holds the pressure value sent as 'humidity'
            row.battery,
            row.batt_current,
            row.gps_sats,
            row.gps_lat,
            row.gps_lon,
            row.gps_time,
            row.gps_date,
            row.gps_alt,
            row.gps_speed,
            row.accel_x,
            row.accel_y,
            row.accel_z,
            row.gyro_x,
            row.gyro_y,
            row.gyro_z,
            row.esc1_rpm,
            row.esc2_rpm,
            row.esc3_rpm,
            row.esc4_rpm,
          ];
          csvRows.push(
            values
              .map((val) => (val === undefined || val === null ? "" : val))
              .join(",")
          );
        });

        const csvString = csvRows.join("\n");
        const dataBlob = new Blob([csvString], {
          type: "text/csv;charset=utf-8;",
        });
        const downloadLink = document.createElement("a");
        const fileUrl = URL.createObjectURL(dataBlob);

        downloadLink.setAttribute("href", fileUrl);
        downloadLink.setAttribute(
          "download",
          `HW-233_Data_Export_${new Date()
            .toISOString()
            .replace(/:/g, "-")}.csv`
        );
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        alert(
          `Successfully exported ${fullHistoricalData.length} records to CSV!`
        );
      }
      window.saveDataAsCsv = saveDataAsCsv;

      refreshSerialPorts();

      applySettingsButton.addEventListener("click", () => {
        const port = serialPortSelect.value;
        const baud = baudRateSelect.value;

        dataStreamSocket.emit("change_serial_settings", { port, baud });
        alert(
          `Requesting server to change settings to Port: ${port}, Baud: ${baud}. Check your server console for status.`
        );
      });
    </script>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal" onclick="event.target === this && closeExportModal()">
      <div class="export-modal">
        <div class="modal-header">
          <h2><i class="fas fa-download"></i> Export Data</h2>
          <button class="modal-close" onclick="closeExportModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="exportFormat">File Format</label>
            <select id="exportFormat">
              <option value="csv">CSV (Comma Separated Values)</option>
              <option value="xlsx">XLSX (Excel Spreadsheet)</option>
              <option value="json">JSON (JavaScript Object Notation)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="exportTimeframe">Time Frame</label>
            <select id="exportTimeframe">
              <option value="0">All Available Data</option>
              <option value="5">Last 5 Minutes</option>
              <option value="15">Last 15 Minutes</option>
              <option value="30">Last 30 Minutes</option>
              <option value="60">Last 1 Hour</option>
              <option value="180">Last 3 Hours</option>
              <option value="360">Last 6 Hours</option>
              <option value="720">Last 12 Hours</option>
              <option value="1440">Last 24 Hours</option>
            </select>
          </div>

          <div class="form-group">
            <label>Select Attributes to Export</label>
            <button class="select-all-btn" onclick="toggleSelectAllAttributes()">
              <i class="fas fa-check-double"></i> Select All / Deselect All
            </button>
            <div class="checkbox-group" id="attributesList">
              <div class="checkbox-item">
                <input type="checkbox" id="attr_ota" value="ota" checked>
                <label for="attr_ota">OTA Value</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_voltage" value="voltage" checked>
                <label for="attr_voltage">Voltage</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_temperature" value="temperature" checked>
                <label for="attr_temperature">Temperature</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_pressure" value="humidity" checked>
                <label for="attr_pressure">Pressure</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_battery" value="battery" checked>
                <label for="attr_battery">Battery %</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_batt_current" value="batt_current" checked>
                <label for="attr_batt_current">Battery Current</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_gps_sats" value="gps_sats" checked>
                <label for="attr_gps_sats">GPS Satellites</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_gps_lat" value="gps_lat" checked>
                <label for="attr_gps_lat">GPS Latitude</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_gps_lon" value="gps_lon" checked>
                <label for="attr_gps_lon">GPS Longitude</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_gps_time" value="gps_time" checked>
                <label for="attr_gps_time">GPS Time</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_gps_date" value="gps_date" checked>
                <label for="attr_gps_date">GPS Date</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_gps_alt" value="gps_alt" checked>
                <label for="attr_gps_alt">GPS Altitude</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_gps_speed" value="gps_speed" checked>
                <label for="attr_gps_speed">GPS Speed</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_accel_x" value="accel_x" checked>
                <label for="attr_accel_x">Accel X</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_accel_y" value="accel_y" checked>
                <label for="attr_accel_y">Accel Y</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_accel_z" value="accel_z" checked>
                <label for="attr_accel_z">Accel Z</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_gyro_x" value="gyro_x" checked>
                <label for="attr_gyro_x">Gyro X</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_gyro_y" value="gyro_y" checked>
                <label for="attr_gyro_y">Gyro Y</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_gyro_z" value="gyro_z" checked>
                <label for="attr_gyro_z">Gyro Z</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_esc1_rpm" value="esc1_rpm" checked>
                <label for="attr_esc1_rpm">ESC1 RPM</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_esc2_rpm" value="esc2_rpm" checked>
                <label for="attr_esc2_rpm">ESC2 RPM</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_esc3_rpm" value="esc3_rpm" checked>
                <label for="attr_esc3_rpm">ESC3 RPM</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_esc4_rpm" value="esc4_rpm" checked>
                <label for="attr_esc4_rpm">ESC4 RPM</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="attr_timestamp" value="timestamp" checked>
                <label for="attr_timestamp">Timestamp</label>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="exportFilename">Filename</label>
            <input type="text" id="exportFilename" placeholder="Leave empty for auto-generated name">
          </div>

          <div class="form-group">
            <label for="exportPath">Save Location</label>
            <div class="path-input-group">
              <input type="text" id="exportPath" placeholder="Click 'Browse' to select save location" readonly style="flex: 1; cursor: pointer;">
              <button onclick="selectSavePath()" class="browse-path-btn">
                <i class="fas fa-folder-open"></i> Browse
              </button>
            </div>
          </div>

          <div class="form-group">
            <div class="checkbox-item">
              <input type="checkbox" id="clearAfterExport">
              <label for="clearAfterExport">Clear data from memory after export</label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" onclick="closeExportModal()">Cancel</button>
          <button class="btn-export" onclick="performExport()">
            <i class="fas fa-download"></i> Export
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
<!-- import "dotenv/config.js";
import express from "express";
import http from "http";
import { Server as SocketIOServer } from "socket.io";
import path from "path";
import { fileURLToPath } from "url";
import startSerial from "./serialmonitor.js";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const server = http.createServer(app);
const io = new SocketIOServer(server);


app.use(express.static(path.join(__dirname, '..', 'frontend')));

startSerial(io);
app.use(express.urlencoded({ extended: true }));

app.post("/test-data", (req, res) => {
  const { ota, voltage } = req.body;
  if (!ota || !voltage) {
    return res.status(400).json({ error: "Missing ota or voltage" });
  }
  const otaVal = parseInt(ota);
  const voltageVal = parseFloat(voltage);
  if (isNaN(otaVal) || isNaN(voltageVal)) {
    return res.status(400).json({ error: "Invalid values" });
  }

 -->
